/*
 * Zarylse [2003-09-07]
 *  - added autogenerated craft help file
 *  - fixed formatting
 */

#include <const.h>
#include <reports.h>
#include <textdraw.h>
#include <sys/regexp.h>

/* Executes the "help" command. Searches for the
 * file <str>.hlp in all of the directories given in the
 * help_paths environment variable and, if found,
 * formats the file and dumps it to the player's terminal.
 * \param str The topic you want help about.
 */
int main( string param ) {
   string str, temp;
   int pathloop;
   string *help_paths;

   help_paths = this_player()->query_env_var( "help_paths" );
   if( !help_paths ) help_paths = ({ });
   if ( member(help_paths, "/help") < 0 )
      help_paths += ({ "/help" });
   if ( member(help_paths, "/help/spell") < 0 )
      help_paths += ({ "/help/spell" });
   if ( member(help_paths, "/help/skill") < 0 )
      help_paths += ({ "/help/skill" });
   if ( this_player()->query_level() >= WIZLEVEL && member(help_paths, "/help/wiz") < 0 )
      help_paths += ({ "/help/wiz" });

   if ( !param ) param = "main";
   str = lower_case(param);
   str = implode( explode(str, " "), "_" );
   for ( pathloop = 0; pathloop < sizeof(help_paths); pathloop++ ) {
      temp = read_file(help_paths[pathloop]+"/"+str+".hlp");
      if ( temp ) break;
   }

   // the str check here is so that skill/craft doesn't step on the autogenerated page
   if ( !temp || param == "craft" ) {
      // autogenerates craft help file
      // update: 'help craft' now only displays an index of categories,
      //         actual recipe listings will be displayed via 'help craft cat'
      if ( str[0..4] == "craft" ) {
         string *match, *files, *lines;
         string file, line;

         if( str == "craft" || str == "crafts" || str == "crafting" ) {
            temp = "PLAYER COMMANDS\n"+
                   "CRAFT\n"+
                   "You can ~CCOMcraft~CHLP and ~CCOMbuild~CHLP many "+
                   "different sorts of things in the game as long as you "+
                   "have the materials and know the recipe.\n\n"+
                   "Because there are so many different recipes in the game, "+
                   "we have divided them up into a bunch of categories. "+
                   "For a listing of individual recipes within each "+
                   "of these categories, type ~CCOMhelp craft <category>"+
                   "~CHLP.\n\n~CTITRecipe categories:\n\n~CBRT";;

            // draw category list
            files = get_dir( "/econ/recipes/*.c" );
            foreach( file : files ) {
               if ( file_size("/econ/recipes/" + file) == FSIZE_DIR )
                  continue;
               if ( file == "testing.c" && this_player()->query_level() < WIZLEVEL )
                  continue;
               temp += pad(implode(explode(capitalize(file[..<3]),"_")," "),19,0);
            }
            temp += "\n\n";

         } else
         if( str[5] == '_' ) {
            string category;
            sscanf(str,"craft_%s",category);
            //debug(str+", "+category);

            temp = "PLAYER COMMANDS\n"+
                   "CRAFT "+upper_case(category)+"\n"+
                   "Use ~CCOMrecipe <item>~CHLP to see what "+
                   "ingredients are required. To use specific materials, "+
                   "you should type ~CCOMcraft <item> using <materials>~CHLP "+
                   "-- for example, ~CCOMcraft metal boots using "+
                   "gold~CHLP. If you are crafting a liquid object, you will "+
				   "need to ~CCOMcraft <item> into <container>~CHLP (where "+
				   "the container has sufficient room). If necessary, you "+
				   "can combine these two options.~CBRT\n\n"+
                   "Recipes in the ~CTIT"+capitalize(category)+"~CBRT category:~CDEF\n\n";

            files = get_dir( "/econ/recipes/"+category+".c" );
            if( !sizeof(files) || (category == "testing" && this_player()->query_level() < WIZLEVEL) ) {
               temp = "PLAYER COMMANDS\n"+
                      "CRAFT\n"+
                      "There is no such crafting recipe category ~CCOM"+
                      category+"~CHLP. Type ~CCOMhelp craft~CHLP for a "+
                      "listing of valid categories.\n\n";
            } else
            foreach ( file : files ) {
               lines = explode( read_file("/econ/recipes/" + file), "\n" );
               foreach ( line : lines ) {
                  if ( (match = regmatch(line, "add_recipe[(] \"(.+)\"", RE_MATCH_SUBS )) &&
                       RECIPE_DAEMON->query_recipe(match[1]) )
                     temp += match[1] + ", ";
               }
               temp = temp[..<3] + "\n\n";
            }
         } // end: craft category

         temp += "~CLABSee also: ~CREFrecipe~CHLP, ~CREFskill/craft~CHLP";
      } // end: if crafting

      // autogenerates soul help files
      else if ( file_exists("/bin/soul/" + str + ".c") ) {
         string buf1, buf2;
         temp = "SOUL\nSOUL COMMANDS\n";
         temp += capitalize(str) + " is a soul command. It can be used in conversation, and some NPC's might understand it. " +
                "It can be used with or without a target. Here's what it should look like:\n\n";

         set_actor( load_object("/daemon/eric") );
         set_target( load_object("/daemon/felicia") );
         set_listener( this_player() );
         buf1 = ("/bin/soul/"+str)->query_cself();
         buf2 = ("/bin/soul/"+str)->query_ctarget();

         if ( !buf1 || !buf2 )
           temp = "SOUL\nSPECIAL SOUL COMMAND\nThis is a custom soul command, " +
                  "and is not set up properly for building a help file from it. Please file a 'nohelp' on it.";
         else {
            buf1 = explode( buf1, "@@" )[0];
            buf1 = process_grammar( buf1 );
            buf2 = explode( buf2, "@@" )[0];
            buf2 = process_grammar( buf2 );
            temp += " ~CEMO" + buf1 + "\n " + buf2 + "\n\n~CHLPSee also: ~CREFsouls";
         }
      } // end: if soul

      // checks man pages for wizards
      else if ( this_player()->query_level() >= WIZLEVEL ) {
         msg( "==> [Help] Checking man pages..." );
         if ( !"/bin/wiz/man"->main(str) ) {
            notify_fail( "==> [Help] No help on that subject. Use 'nohelp' to suggest we create some.\n" );
            log_file( "nohelp", "Attempted to get help on " + str + "\n" );
            return 0;
         }
         return 1;
      } // end: if player is wizard

      // no help file found
      else {
         msg( "I couldn't find help on that subject. If you think there should be help on this topic, " +
              "add it to our list by typing 'nohelp " + str + "'" );
         log_file( "nohelp", "Attempted to get help on " + str + "\n" );
         return 1;
      } // end: if file not found
   }

   // follows cross-referenced help files
   if ( temp[0] == '!' ) {
      temp = temp[1..];
      while ( temp[<1] == '\n' || temp[<1] == ' ' )
         temp = temp[..<2];
      if ( temp[<4..<1] != ".hlp" )
         temp += ".hlp";
      temp = read_file( temp );
   }
   if( !temp ) {
      msg( "==> [Help] That file was marked as a cross-reference, but the reference is broken. " +
           "Please use 'typo' to send us a bug report." );
      return 1;
   }

   if ( this_player()->query_level() >= WIZLEVEL )
      if ( (file_exists("/help/" + str + ".hlp") || file_exists("/help/spell/" + str + ".hlp")) && file_exists("/help/wiz/" + str + ".hlp") )
         temp += "\n ~CWRNWizards, see also: ~CCOMhelp wiz/" + str + "~CHLP";
   if ( file_exists("/help/" + str + ".hlp") && file_exists("/help/spell/" + str + ".hlp") )
         temp += "\n ~CWRNFor the spell, see also: ~CCOMhelp spell/" + str + "~CHLP";
   if ( file_exists("/help/" + str + ".hlp") && file_exists("/help/skill/" + str + ".hlp") )
         temp += "\n ~CWRNFor the skill, see also: ~CCOMhelp skill/" + str + "~CHLP";

   help_frame(temp);
   return 1;
}
